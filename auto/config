#!/bin/sh
set -e

if [ -e /etc/timezone ]; then
  TZ=" timezone=$(cat /etc/timezone)"
fi

if [ -e /etc/default/keyboard ]; then
  KB=" $(
    . /etc/default/keyboard
    echo "${XKBLAYOUT:+keyboard-layouts=$XKBLAYOUT}"
    echo "${XKBMODEL:+keyboard-model=$XKBMODEL}"
    echo "${XKBOPTIONS:+keyboard-options=$XKBOPTIONS}"
    echo "${XKBVARIANT:+keyboard-variants=$XKBVARIANT}"
  )"
fi

lb config noauto \
  --iso-volume mame-live \
  --tasksel apt \
  --system live \
  --binary-images iso-hybrid \
  --distribution testing \
  --archive-areas main \
  --architectures amd64 \
  --debian-installer false \
  --security false \
  --updates false \
  --backports false \
  --memtest none \
  --win32-loader false \
  --bootloaders grub-efi \
  --debootstrap-options '--variant=minbase' \
  --bootappend-live "boot=live quiet nosplash components$TZ$KB" \
  --apt-recommends false \
  "${@}"

  #--apt-indices false \
  #--firmware-chroot false \
  #todo: components

if [ -n "$DEV" ]; then
  ln -s auto/dev-tools.list.chroot config/package-lists/_dev-tools.list.chroot
else
  ln -s auto/apt-minimal.hook.chroot config/hooks/normal/9975-_apt-minimal.hook.chroot
  ln -s auto/dpkg-minimal.hook.chroot config/hooks/normal/9985-_dpkg-minimal.hook.chroot
fi
